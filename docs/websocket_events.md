# WebSocket Event Contracts

This document describes the JSON payloads exchanged through the WebSocket
gateway and the environment requirements that must be satisfied before
deploying the realtime stack.

## Dependencies

- Redis 6+ accessible through the URI provided in `REDIS_URL`.  
  Example: `redis://localhost:6379/0`.
- Optional: `CHAT_PUBSUB_CHANNEL` to customise the Redis pub/sub channel name.
- Server-side heartbeat configuration (defaults are shown):
  - `WEBSOCKET_HEARTBEAT_INTERVAL` (default: `30` seconds).
  - `WEBSOCKET_IDLE_TIMEOUT` (default: `90` seconds).
  - `WEBSOCKET_CONNECTION_TTL` (default: `120` seconds) – TTL applied to the
    presence hash `connection:{user_id}` in Redis.

All configuration variables can be declared in `.env` or the hosting platform.

## Events

### `chat.message`

Broadcast when a new message is stored in a chat. Delivered to every client
subscribed to the chat.

```json
{
  "type": "chat.message",
  "chat_id": 42,
  "message": {
    "message_id": 123,
    "chat_id": 42,
    "user_id": 7,
    "sender_username": "alice",
    "content": "Hola!",
    "created_at": "2024-05-20T16:45:33Z",
    "attachments": []
  }
}
```

### `user.status`

Presence updates for a user. Emitted on connect, disconnect, and automatic
timeouts. Also published through Redis so that all application replicas share
the same view.

```json
{
  "type": "user.status",
  "user_id": 7,
  "status": "connected",
  "last_seen": "2024-05-20T16:45:33.482Z",
  "connection_count": 2
}
```

Fields:

- `status`: one of `connected`, `inactive`, or `disconnected`.
- `last_seen`: ISO 8601 timestamp (UTC) of the last activity registered for the
  user.
- `connection_count`: number of WebSocket sessions currently tracked for the
  user (0 when disconnected).

### `system.pong`

Heartbeat acknowledgement message that the **client must send** after receiving
`system.ping` from the server or after initiating its own ping request. The
server responds with the same payload so that the frontend can confirm the RTT
and connection parameters.

Server → Client (heartbeat request):

```json
{
  "type": "system.ping",
  "ping_id": "a5f6c4e9859346ab9a7ac9f24a98f8b1",
  "server_timestamp": "2024-05-20T16:45:33.482Z"
}
```

Client → Server (acknowledgement):

```json
{ "type": "system.pong", "ping_id": "a5f6c4e9859346ab9a7ac9f24a98f8b1" }
```

Server → Client (confirmation):

```json
{
  "type": "system.pong",
  "ping_id": "a5f6c4e9859346ab9a7ac9f24a98f8b1",
  "server_timestamp": "2024-05-20T16:45:33.482Z",
  "connection_ttl": 120
}
```

- `ping_id`: identifier provided either by the client or generated by the
  server to correlate the heartbeat exchange.
- `server_timestamp`: UTC timestamp when the pong was produced.
- `connection_ttl`: presence TTL (seconds) currently applied in Redis so the
  client can coordinate its reconnection backoff if needed.

Any inbound `system.pong` resets the inactivity timer on the server. If the
server detects that a client has not responded within `WEBSOCKET_IDLE_TIMEOUT`
it will close the connection proactively.
